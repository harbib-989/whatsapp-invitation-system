"""
????? ???? ?????? ??????? ????????? ????? ????????
?????? Content Template ?? Twilio ?????? ??????? ?? WhatsApp

????? ???????:
1. ???? ??? Content SID ?? ????????
2. ???? ?? config.json ?? ????? CONTENT_SID_VIP ??? Render
3. ????? ?????? WhatsApp (Twilio Console ? Content ? Submit)
"""
import os
import sys
import json
from datetime import datetime

if sys.platform == "win32":
    sys.stdout.reconfigure(encoding="utf-8", errors="replace")

try:
    from dotenv import load_dotenv
    load_dotenv()
except ImportError:
    pass

try:
    import requests as http_requests
except ImportError:
    print("? ?????: pip install requests")
    sys.exit(1)

ACCOUNT_SID = os.environ.get("TWILIO_ACCOUNT_SID")
AUTH_TOKEN = os.environ.get("TWILIO_AUTH_TOKEN")

if not ACCOUNT_SID or not AUTH_TOKEN:
    print("? ???? ?? ????? TWILIO_ACCOUNT_SID ? TWILIO_AUTH_TOKEN ?? .env")
    sys.exit(1)

# ?? ?????? ?????? - ????? 1: ?????? ????? 2: ??????
BODY_TEXT = (
    "???? ?????\n\n"
    "?????? {{1}} {{2}} ???? ????\n"
    "?????? ????? ????? ???? ???????\n\n"
    "??? ?????? ??????? ???????? ?? ????? ??????? ??????? ?????:\n\n"
    "????? ???????? ???????\n\n"
    "?? ???????: ??? ????? 15\n"
    "? ?????: ????? ????????\n"
    "?? ??????: ???? ?????? ??????? - ?????? ??????? ????????\n\n"
    "?????? ????? ???????\n\n"
    "?????? ??????? ????????\n"
    "??????? ?????? ??????? ?????? ???????"
)

def main():
    print("=" * 60)
    print("  ????? ???? ?????? ??????? ?????????")
    print("=" * 60)

    template_data = {
        "friendly_name": "job_fair_vip_" + datetime.now().strftime("%Y%m%d%H%M%S"),
        "language": "ar",
        "variables": {"1": "?????", "2": "??????"},
        "types": {
            "twilio/quick-reply": {
                "body": BODY_TEXT,
                "actions": [
                    {"title": "????? ??????", "id": "accept"},
                    {"title": "??????", "id": "decline"}
                ]
            },
            "twilio/text": {
                "body": BODY_TEXT + "\n\n???? ???? ????? ?? ??????"
            }
        }
    }

    try:
        resp = http_requests.post(
            "https://content.twilio.com/v1/Content",
            json=template_data,
            auth=(ACCOUNT_SID, AUTH_TOKEN)
        )

        if resp.status_code != 201:
            print(f"? ???: {resp.status_code}")
            print(resp.text)
            sys.exit(1)

        sid = resp.json().get("sid")
        print(f"\n? ?? ????? ?????? ?????!")
        print(f"\n?? Content SID: {sid}")
        print(f"\n??????? ???????:")
        print("  1. ???? ??? Twilio Console ? Content ? ?????? ?????? ?????")
        print("  2. ???? Submit for Approval ?????? ?????? ??????? WhatsApp")
        print("  3. ??? ????????? ??? ?? config.json:")
        print(f'     "content_sid_vip": "{sid}"')
        print("  4. ?? ??? Render ??? ?????:")
        print(f"     CONTENT_SID_VIP={sid}")
        print("\n" + "=" * 60)
        return sid

    except Exception as e:
        print(f"? ???: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
